<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
</head>

<body>
<iframe id="player"></iframe>

<script type="text/javascript">
// classes

/**
 * 用于管理处状态类
 * @class StatusManager
 */
// status
// 1g player已连接
var CONNECT = 'connect';
// 1g player断开连接
var DISCONNECT = 'disconnect';
// 读取歌曲中
var LOADING = 'loading';
// 播放中
var PLAYING = 'playing';
// 暂停
var PAUSED = 'paused';
// 停止
var STOP = 'stop';
// 启用1g
var ON = 'on';
// 关闭1g
var OFF = 'off'

function StatusManager() {
	this.status_ = OFF;
	this.stateChangeListeners_ = [];
}

StatusManager.prototype.setStatus = function(status){
	if (status !== this.status_) {
		this.status_ = status;
		this.fireStateChangeListener_();
	}
}

StatusManager.prototype.getStatus = function(){
	return this.status_;
}

StatusManager.prototype.addStateChangeListener = function(fn){
	this.stateChangeListeners_.push(fn);
}

StatusManager.prototype.removeStateChangeListener = function(fn){
	var index = this.stateChangeListeners_.indexOf(fn);
	if (index >= 0) {
		this.stateChangeListeners_.splice(index, 1);
	}
}

StatusManager.prototype.fireStateChangeListener_ = function(){
	var status = this.status_;
	for (var i=0; i<this.stateChangeListeners_.length; i++) {
		this.stateChangeListeners_[i]({status: status});
	}
}


// 读取效果
// A "loading" animation displayed while we wait for the first response from
// Gmail. This animates the badge text with a dot that cycles from left to
// right.
function LoadingAnimation() {
  this.timerId_ = 0;
  this.maxCount_ = 8;  // Total number of states in animation
  this.current_ = 0;  // Current state
  this.maxDot_ = 4;  // Max number of dots in animation
}

LoadingAnimation.prototype.paintFrame = function() {
  var text = "";
  for (var i = 0; i < this.maxDot_; i++) {
    text += (i == this.current_) ? "." : " ";
  }
  if (this.current_ >= this.maxDot_)
    text += "";

  chrome.browserAction.setBadgeText({text:text});
  this.current_++;
  if (this.current_ == this.maxCount_)
    this.current_ = 0;
}

LoadingAnimation.prototype.start = function() {
  if (this.timerId_)
    return;

  var self = this;
  this.timerId_ = window.setInterval(function() {
    self.paintFrame();
  }, 100);
}

LoadingAnimation.prototype.stop = function() {
  if (!this.timerId_)
    return;

  window.clearInterval(this.timerId_);
  this.timerId_ = 0;
}
	

/**
 * 歌曲数据模型
 * @class SongModel 
 */
function SongModel() {
	this.displayText_ = '';
	this.displayChangeListeners_ = [];
}

SongModel.prototype.setDisplayText = function(text){
	this.displayText_ = text;
	this.fireDisplayChangeListener_();
}

SongModel.prototype.addDisplayChangeListener = function(fn){
	this.displayChangeListeners_.push(fn);
}

SongModel.prototype.removeDisplayChangeListener = function(fn){
	var index = this.displayChangeListeners_.indexOf(fn);
	if (index >= 0) {
		this.displayChangeListeners_.splice(index, 1);
	}
}

SongModel.prototype.fireDisplayChangeListener_ = function(){
	var self = this;
	this.displayChangeListeners_.forEach(function(listener){
		listener({text: self.displayText_});
	});
}

/**
 * 信息面板
 * @class InfoPane
 */
var NOTIFICATION_PAGE = 'notification.html';
 
function InfoPane(){
	this.title_ = '';
	this.content_ = '';
}

InfoPane.prototype.show = function(){
	if (this.notification_) {
		this.close();
	}
	this.notification_ = webkitNotifications.createHTMLNotification(NOTIFICATION_PAGE);
	var self = this;
	this.notification_.addEventListener('close', function(){
		self.clearEles_();
		self.notification_ = null;
	});
	this.notification_.show();
}

InfoPane.prototype.close = function(){
	if (this.notification_) {
		this.notification_.cancel();
		this.notification_ = null;
		this.clearEles_();	
	}
}

InfoPane.prototype.setTitle = function(text){
	if (!this.titleEle_){
		this.getEles_();
	}	
	if (this.titleEle_) {
		this.titleEle_.innerText = text;
		this.title_ = text;
	}
}

InfoPane.prototype.setContent = function(text){
	if (!this.contentEle_) {
		this.getEles_();
	}
	if (this.contentEle_) {
		this.contentEle_.innerText = text;
		this.content_ = text
	}
}

InfoPane.prototype.isClose = function(){
	return !this.notification_;
}

InfoPane.prototype.getEles_ = function(){
	var win = chrome.extension.getViews({type: 'notification'})[0];
	if (win) {
		this.titleEle_ = win.document.getElementById('title');
		this.contentEle_ = win.document.getElementById('content');
	}
}

InfoPane.prototype.clearEles_ = function(){
	this.notificationWin_ = null;
	this.titleEle_ = null;
	this.contentEle_ = null;
}


// initialize 

// badge提示字符(播放状态)
var BADGE_ON_TEXT = 'on';
// badge背景色
var BADGE_BACKGROUND_COLOR = [255, 0, 0, 0];
// 播放器地址	
var URL = 'http://1g1g.com';
// player 窗口宽度 	
var WIN_WIDTH = 400;
// player 窗口高度
var WIN_HEIGHT = 570;

var loadingAnimation = new LoadingAnimation();
var statusManager = new StatusManager();
var infoPane = new InfoPane();
var songModel = new SongModel();
var gwin;
var openInWindow = localStorage['innerPlayer'] === 'false';
var showControl = localStorage['showControl'] === 'true' || localStorage['showControl'] === undefined;
var innerPlayer = document.getElementById('player');


// 设置badge背景色
chrome.browserAction.setBadgeBackgroundColor({color: BADGE_BACKGROUND_COLOR});	

// status change listener
statusManager.addStateChangeListener(function(event){
	switch (event.status) {
		case CONNECT:
			loadingAnimation.stop();
			chrome.browserAction.setBadgeText({
				text: BADGE_ON_TEXT
			});
		break;
		case DISCONNECT:
			infoPane.close();
			chrome.browserAction.setBadgeText({text: ''});
		break;
		case LOADING:
			infoPane.setTitle('歌曲缓冲中...');	
		break;
		case PLAYING:
			infoPane.setTitle('正在播放');
		break;
		case PAUSED:
			infoPane.setTitle('暂停');
		break;
		case ON:
			//loadingAnimation.start();
			chrome.browserAction.setBadgeText({
				text: BADGE_ON_TEXT
			});
			if (openInWindow) {
				chrome.windows.create({
					url: URL, width: WIN_WIDTH, height:WIN_HEIGHT ,type: 'popup'},
					function(win){
						window.gwin = win;
					});
			} else {
				innerPlayer.src = URL;	
			}
			if (showControl) {
				infoPane.show();
			}
		break;
		case OFF:
			loadingAnimation.stop();
			chrome.browserAction.setBadgeText({text: ''});
			try {
				innerPlayer.src = "";
				infoPane.close();
				chrome.windows.remove(window.gwin.id);
			} catch(e){}
		break;

	}
});

songModel.addDisplayChangeListener(function(event){
	infoPane.setContent(event.text);	
});

/* 1g 事件监听 */
chrome.extension.onConnect.addListener(function(port) {
	port.onMessage.addListener(function(event){
		if (statusManager.getStatus() !== OFF) {
		switch (event.type) {
			case 'disconnect':
				statusManager.setStatus(DISCONNECT);
			break;
			case 'connect':
				statusManager.setStatus(CONNECT);
			break;
			case 'playerState':
				statusManager.setStatus(event.body.state);
			case 'display': 
				if (event.body && event.body.text) {
					songModel.setDisplayText(event.body.text);
				}
			break;
			default:;
			break;
		}
		}
	});	
});

chrome.windows.onRemoved.addListener(function(winId){
	if (gwin && gwin.id == winId) {
		statusManager.setStatus(OFF);	
	}	
});


/* 为content script提供的方法 */
function off(){
	if (statusManager) {
		statusManager.setStatus(OFF);
	}
}

function on(){
	if (statusManager) {
		statusManager.setStatus(ON);
	}
}

function getStatus(){
	if (statusManager) {
		return statusManager.getStatus();
	}
	else return null;
}

function showInfoPane(){
	if (infoPane) {
		infoPane.show();
	}
}

function closeInfoPane(){
	if (infoPane) {
		infoPane.close();
	}
}

function infoPaneIsClose(){
	if (infoPane) {
		return infoPane.isClose();
	}
	else return true;
}

</script>
</body>

</html>
